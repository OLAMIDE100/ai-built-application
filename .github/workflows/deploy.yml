name: Deploy to GKE

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main


env:
  PROJECT_ID: nabuminds-test
  GKE_CLUSTER: general-cluster
  GKE_REGION: europe-west3
  GKE_NAMESPACE: snake-game
  REPOSITORY: snake-game

jobs:
################################################################################################### BACKEND TESTING JOBS ########################################################################################################
  backend-test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests
        working-directory: ./backend
        run: |
          pytest tests/ -v

################################################################################################### FRONTEND TESTING JOBS ########################################################################################################
  frontend-test:
    name: Run Frontend Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test -- --run

################################################################################################### INTEGRATION TESTING JOBS ########################################################################################################
  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-test , frontend-test]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests
        working-directory: ./backend
        run: |
          pytest tests_integration/ -v

################################################################################################### TERRAFORM VALIDATE JOBS ########################################################################################################
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: integration-test
    permissions:
      contents: 'read'
      id-token: 'write'
    defaults:
      run:
        working-directory: ./infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v3'
        with:
          service_account: 'terraform-test-deployment@nabuminds-test.iam.gserviceaccount.com'
          workload_identity_provider: 'projects/563370139005/locations/global/workloadIdentityPools/bitbucket/providers/repository'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Validate
        run: |
          echo "yes" | terraform init 
          echo "yes" | terraform validate 

################################################################################################### TERRAFORM PLAN JOBS ########################################################################################################
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request'
    permissions:
      contents: 'read'
      id-token: 'write'
    defaults:
      run:
        working-directory: ./infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v3'
        with:
          service_account: 'terraform-test-deployment@nabuminds-test.iam.gserviceaccount.com'
          workload_identity_provider: 'projects/563370139005/locations/global/workloadIdentityPools/bitbucket/providers/repository'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Install conftest
        run: |
          LATEST_VERSION=$(wget -O - "https://api.github.com/repos/open-policy-agent/conftest/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | cut -c 2-)
          ARCH=$(arch)
          SYSTEM=$(uname)
          wget "https://github.com/open-policy-agent/conftest/releases/download/v${LATEST_VERSION}/conftest_${LATEST_VERSION}_${SYSTEM}_${ARCH}.tar.gz"
          tar xzf conftest_${LATEST_VERSION}_${SYSTEM}_${ARCH}.tar.gz
          mv conftest /usr/local/bin

      - name: Terraform Init
        run: |
          echo "yes" | terraform init 
          echo "yes" | terraform plan -out=tfplan 
          terraform show -json tfplan > tfplan.json 
          ls

      - name: Run Conftest
        run: |
          conftest test --policy ../../policy tfplan.json --all-namespaces  

################################################################################################### TERRAFORM APPLY JOBS ########################################################################################################
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    permissions:
      contents: 'read'
      id-token: 'write'
    defaults:
      run:
        working-directory: ./infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v3'
        with:
          service_account: 'terraform-test-deployment@nabuminds-test.iam.gserviceaccount.com'
          workload_identity_provider: 'projects/563370139005/locations/global/workloadIdentityPools/bitbucket/providers/repository'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Apply
        run: |
          export TF_VAR_snake_game_db_password=$(gcloud secrets versions access latest --secret="snake-game"  --project $PROJECT_ID | jq -r ".\"postgres-password\"" )   
          echo "yes" | terraform init 
          echo "yes" | terraform plan 
          terraform apply -auto-approve 

################################################################################################### DEPLOY JOBS ########################################################################################################
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: terraform-apply
    permissions:
      contents: 'read'
      id-token: 'write'
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v3'
        with:
          service_account: 'terraform-test-deployment@nabuminds-test.iam.gserviceaccount.com'
          workload_identity_provider: 'projects/563370139005/locations/global/workloadIdentityPools/bitbucket/providers/repository'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure kubectl
        run: |
          gcloud components install gke-gcloud-auth-plugin
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.PROJECT_ID }}

      - name: Generate image tag
        id: meta
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            TAG=$(date +%Y%m%d%H%M%S)
          else
            TAG=$(date +%Y%m%d%H%M%S)-$(echo ${{ github.ref }} | sed 's/refs\/heads\///' | sed 's/\//-/g')
          fi
          export TF_VAR_image_tag=$TAG

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.GKE_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy secrets
        run: |
          kubectl apply -f infrastructure/manifest/secrets/secrets.yaml -n ${{ env.GKE_NAMESPACE }}

      - name: Deploy network resources
        run: |
          kubectl apply -f infrastructure/manifest/network/managed-cert.yaml -n ${{ env.GKE_NAMESPACE }}
          kubectl apply -f infrastructure/manifest/network/ingress.yaml -n ${{ env.GKE_NAMESPACE }}

      - name: Deploy backend configmap
        run: |
          kubectl apply -f infrastructure/manifest/workloads/backend/configmap.yaml -n ${{ env.GKE_NAMESPACE }}

      - name: Deploy backend service
        run: |
          kubectl apply -f infrastructure/manifest/workloads/backend/backend-service.yaml -n ${{ env.GKE_NAMESPACE }}

      - name: Deploy backend deployment
        run: |
          export TF_VAR_image_tag=${{ steps.meta.outputs.tag }}
          export DATABASE_HOST=$(gcloud sql instances describe general-cluster --project nabuminds-test  --format='value(ipAddresses.[0].ipAddress)')
          envsubst < infrastructure/manifest/workloads/backend/pre-backend-deployment.yaml > infrastructure/manifest/workloads/backend/backend-deployment.yaml
          kubectl apply -f infrastructure/manifest/workloads/backend/backend-deployment.yaml -n ${{ env.GKE_NAMESPACE }}
          rm -f infrastructure/manifest/workloads/backend/backend-deployment.yaml

      - name: Deploy frontend service
        run: |
          kubectl apply -f infrastructure/manifest/workloads/frontend/frontend-service.yaml -n ${{ env.GKE_NAMESPACE }}

      - name: Deploy frontend deployment
        run: |
          export TF_VAR_image_tag=${{ steps.meta.outputs.tag }}
          envsubst < infrastructure/manifest/workloads/frontend/pre-frontend-deployment.yaml > infrastructure/manifest/workloads/frontend/frontend-deployment.yaml
          kubectl apply -f infrastructure/manifest/workloads/frontend/frontend-deployment.yaml -n ${{ env.GKE_NAMESPACE }}
          rm -f infrastructure/manifest/workloads/frontend/frontend-deployment.yaml

      - name: Wait for backend rollout
        run: |
          kubectl rollout status deployment/snake-game-backend -n ${{ env.GKE_NAMESPACE }} --timeout=5m

      - name: Wait for frontend rollout
        run: |
          kubectl rollout status deployment/snake-game-frontend -n ${{ env.GKE_NAMESPACE }} --timeout=5m

      - name: Verify deployment
        run: |
          echo "Backend pods:"
          kubectl get pods -n ${{ env.GKE_NAMESPACE }} -l app=snake-game,component=backend
          echo "Frontend pods:"
          kubectl get pods -n ${{ env.GKE_NAMESPACE }} -l app=snake-game,component=frontend
          echo "Services:"
          kubectl get svc -n ${{ env.GKE_NAMESPACE }}
          echo "Ingress:"
          kubectl get ingress -n ${{ env.GKE_NAMESPACE }}

